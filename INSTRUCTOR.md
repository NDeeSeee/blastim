# Руководство преподавателя

Как подготовить HPC, разместить данные и провести занятие.

## Обзор

| Этап | Действие | Когда |
|------|----------|-------|
| **Подготовка** | Установить окружение, загрузить данные/базы | За 1-2 дня до занятия |
| **Проверка** | Тестовый прогон всего рабочего процесса | За день до занятия |
| **Занятие** | Студенты выполняют шаги 10-50 | Во время 2-часового занятия |
| **Сброс** | Очистить результаты для следующей группы | После занятия |

## 1. Требования к дисковому пространству

| Компонент | Размер |
|-----------|--------|
| Conda-окружение | ~2 ГБ |
| FASTA-файл сборки | ~4 МБ |
| Учебные белки (FASTA) | ~200 МБ |
| База данных DIAMOND (.dmnd) | ~50 МБ |
| Pfam-A полная (опционально) | ~1.5 ГБ |
| Pfam подмножество (~200 HMM) | ~5 МБ |
| Результаты на студента | ~50 МБ |
| **Итого (режим подмножества)** | **~2.5 ГБ** |
| **Итого (полная Pfam)** | **~4 ГБ** |

## 2. Настройка окружения

```bash
# Вариант A: micromamba (рекомендуется)
bash env/micromamba_create.sh
micromamba activate ngs-annotation

# Вариант B: conda/mamba
conda env create -f env/environment.yml
conda activate ngs-annotation
```

Проверьте окружение:

```bash
bash scripts/00_check_system.sh
```

Все пункты должны показывать `[OK]`, кроме предупреждений о data/db (их мы настроим далее).

## 3. Размещение данных и баз

Выполните из корня репозитория:

```bash
# Загрузка генома B. subtilis + подмножества белков Swiss-Prot
bash scripts/01_get_data.sh

# Создание базы данных DIAMOND
bash scripts/02_make_diamond_db.sh

# Загрузка Pfam и создание подмножества для быстрой работы на занятии
bash scripts/03_get_pfam.sh --subset
```

Или всё сразу:

```bash
make prep-data
```

Для этого требуется доступ в интернет. После завершения все данные находятся в `data/`, и репозиторий может работать офлайн.

### Офлайн-режим для занятия

Если на HPC нет интернета во время занятия:

1. Запустите все подготовительные скрипты на машине с интернетом.
2. Скопируйте всю директорию `data/` на HPC:
   ```bash
   rsync -avP data/ hpc:/path/to/blastim/data/
   ```
3. Студентам нужен только репозиторий + предварительно подготовленная директория `data/`.

### Опционально: полная Pfam

Для продвинутых студентов или если есть время:

```bash
bash scripts/03_get_pfam.sh --full
```

Затем отредактируйте `workflow/config.sh`:
```bash
HMM_DB="data/db/Pfam-A.hmm"
```

Внимание: hmmscan с полной Pfam занимает 15-30 минут на 8 ядрах для этого генома.

## 4. Тестовый прогон

Запустите полный рабочий процесс для проверки:

```bash
cp workflow/config.sh.example workflow/config.sh
bash workflow/run_all.sh
```

### Ожидаемое время выполнения (8 ядер, подмножество Pfam)

| Шаг | Ожидаемое время |
|-----|-----------------|
| Prokka | 3-8 мин |
| DIAMOND | 1-2 мин |
| hmmscan (подмножество) | 2-5 мин |
| hmmscan (полная Pfam) | 15-30 мин |
| Проверки качества | <1 мин |
| **Итого (подмножество)** | **~10-20 мин** |

### Ожидаемые результаты (приблизительно, B. subtilis 168)

| Метрика | Ожидаемый диапазон |
|---------|-------------------|
| Предсказанные CDS | 4 200 - 4 400 |
| Предсказанные tRNA | 80 - 90 |
| Предсказанные rRNA | 10 - 30 |
| Белки с попаданиями DIAMOND | 3 000 - 4 000 |
| Белки с доменами Pfam (подмнож.) | 1 500 - 2 500 |
| Гипотетические белки | 200 - 800 |

Если значения существенно отличаются, проверьте версии инструментов и содержимое баз данных.

## 5. Рабочий процесс студентов

Студенты должны:

1. Скопировать файл конфигурации:
   ```bash
   cp workflow/config.sh.example workflow/config.sh
   ```

2. Запустить полный рабочий процесс:
   ```bash
   bash workflow/run_all.sh
   ```

   Или пошагово (рекомендуется для обучения):
   ```bash
   bash scripts/10_run_prokka.sh
   bash scripts/20_run_diamond.sh
   bash scripts/30_run_hmmscan.sh
   bash scripts/40_sanity_checks.sh
   bash scripts/50_pick_3_genes.sh
   ```

3. Исследовать результаты с помощью команд из `docs/cheatsheet.md`.

## 6. План Б: hmmscan работает слишком долго

Если hmmscan занимает слишком много времени на занятии:

### Вариант A: Ограничить количество белков
```bash
bash scripts/30_run_hmmscan.sh --max-proteins 200
```
Анализируются только первые 200 белков. Выполняется за ~1 мин.

### Вариант B: Использовать только подмножество HMM
Убедитесь, что в `config.sh` указано:
```bash
HMM_DB="data/db/pfam_subset.hmm"
```

### Вариант C: Пропустить hmmscan
Студенты могут учиться на результатах Prokka + DIAMOND. Выполните только шаги 10, 20, 40, 50.

## 7. Сброс между группами

```bash
make clean
```

Это удалит все директории `outputs/run_*`, но сохранит базы данных.

Для полного сброса (включая базы данных):
```bash
make clean-all
```

## 8. Рекомендуемый план занятия (2 часа)

| Время | Активность |
|-------|-----------|
| 0:00-0:10 | Введение: что такое аннотация генома? Концепция лестницы доказательств |
| 0:10-0:15 | Подключение по SSH, активация окружения, копирование конфигурации |
| 0:15-0:25 | Запуск Prokka; пока ждём: объяснение формата GFF |
| 0:25-0:35 | Изучение результатов Prokka (GFF, FAA, TSV) |
| 0:35-0:45 | Запуск DIAMOND; объяснение табличного формата BLAST |
| 0:45-0:55 | Изучение результатов DIAMOND; обсуждение идентичности/E-value |
| 0:55-1:10 | Запуск hmmscan; объяснение HMM-профилей и Pfam |
| 1:10-1:20 | Изучение результатов hmmscan; популярные домены |
| 1:20-1:35 | Запуск проверок качества; обсуждение лестницы доказательств |
| 1:35-1:50 | Упражнение «Выбери 3 гена»; обсуждение в группе |
| 1:50-2:00 | Итоги: аннотация в реальных проектах, ограничения, дополнительные ресурсы |

## 9. Примечания о лицензиях

- **Swiss-Prot**: Загружается с UniProt (CC BY 4.0). Не коммитится в репозиторий.
- **Pfam**: Загружается с EBI/InterPro. Не коммитится в репозиторий.
- **Геном B. subtilis 168**: NCBI RefSeq, общественное достояние.
- **Материалы курса**: лицензия MIT.

Не коммитьте полные базы данных в git-репозиторий. Они исключены через .gitignore.

## 10. Устранение неполадок

См. `docs/troubleshooting.md` для описания частых проблем и их решений.
