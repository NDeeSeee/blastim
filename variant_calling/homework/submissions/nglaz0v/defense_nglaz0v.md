# HW2 -- Variant Defense (*Bacillus subtilis* 168)

**Student:** `<GITHUB_USER>`
**Run dir:** `outputs/<run_...>/`
**Assigned variants file:** `variants_<GITHUB_USER>.txt` (5 вариантов)

> **Справочник:** См. `docs/vcf_glossary.md` для подробного описания всех полей VCF и метрик freebayes.
> **Полное задание:** См. `docs/homework_02.md` для контекста и критериев оценивания.

---

## Что такое Variant Defense?

Это ручная проверка качества вариантов после автоматического variant calling. Вы анализируете метрики качества (QUAL, DP, strand bias, mapping quality) и выносите вердикт: настоящий вариант или артефакт секвенирования.

**Цель:** Научиться критически оценивать результаты variant calling и использовать метрики VCF для обоснованных решений.

---

## Вариант 1: NC_000964.3:123456 G→A (ПРИМЕР)

### 1. Позиция и основные данные

- **CHROM:POS:** NC_000964.3:123456
- **REF → ALT:** G → A
- **Тип:** SNP
- **QUAL:** 245.6
- **DP:** 35
- **AO / RO:** 34 / 1
- **SAF / SAR:** 17 / 17 (ALT forward / reverse)
- **SAP:** 3.2 (strand bias p-value)
- **MQM:** 60 (mean mapping quality)

### 2. Доказательства ЗА (вариант настоящий)

1. **QUAL очень высокий** — 245.6 >> 30 (минимум), >> 100 (уверенно). Высокая статистическая уверенность.
2. **DP адекватная** — 35 в диапазоне 10-200. Достаточно прочтений для надёжного вызова.
3. **Частота ALT ~100%** — AO/DP = 34/35 = 97%. Ожидаемо для гаплоида (*B. subtilis*).
4. **Нет strand bias** — SAP=3.2 < 20, SAF=17 и SAR=17 примерно равны. ALT прочтения на обеих цепях.
5. **Высокое качество маппинга** — MQM=60 >> 20. Прочтения уверенно выровнены.

### 3. Доказательства ПРОТИВ (вариант = артефакт)

1. **Нет значимых фактов против** — все метрики в норме.

### 4. Вердикт

- [X] **ACCEPT** — вариант настоящий, высокая уверенность
- [ ] **ACCEPT with caution** — скорее настоящий, но есть сомнения
- [ ] **REJECT** — скорее артефакт
- [ ] **UNCLEAR** — недостаточно данных

**Обоснование:**
Все метрики указывают на настоящий SNP: очень высокий QUAL, нормальная глубина, почти 100% ALT прочтений, нет strand bias, отличное качество маппинга. Нет причин сомневаться.

### 5. Предложение фильтра

Фильтр для отбора высококачественных вариантов как этот:

```bash
bcftools view -i 'QUAL>=100 && INFO/DP>=20 && INFO/SAP<20 && INFO/MQM>=20'
```

**Обоснование:** Этот фильтр пропустит варианты с высоким QUAL, достаточной глубиной, без strand bias и с хорошим mapping quality.

---

## Вариант 2

### 1. Позиция и основные данные

- **CHROM:POS:**
- **REF → ALT:**
- **Тип:** SNP / insertion / deletion
- **QUAL:**
- **DP:**
- **AO / RO:**
- **SAF / SAR:**
- **SAP:**
- **MQM:**

### 2. Доказательства ЗА (вариант настоящий)

Перечислите факты, которые **поддерживают**, что вариант настоящий:

1.
2.
3.

**Критерии для аргументов ЗА:**
- QUAL **≥ 30** (минимум), **≥ 100** (уверенно)
- DP **≥ 10** (минимум), **≥ 20** (уверенно), **< 200** (не дупликация)
- AO/DP **~100%** для гаплоида (допустимо 70-100%)
- SAP **< 20** (нет strand bias); SAF и SAR примерно равны
- MQM **≥ 20** (хорошее качество маппинга), **≥ 40** (отлично)

### 3. Доказательства ПРОТИВ (вариант = артефакт)

Перечислите факты, которые **указывают на артефакт**:

1.
2.

**Критерии для аргументов ПРОТИВ:**
- QUAL **< 20** (очень низкий)
- DP **< 5** (слишком мало данных) или **> 200** (возможная дупликация)
- AO/DP **< 70%** для гаплоида (подозрительно низкая частота)
- SAP **> 20** (сильный strand bias — все ALT с одной цепи)
- RPP **> 20** (position bias — ALT прочтения скучкованы в одной части)
- MQM **< 20** (плохое качество маппинга)

### 4. Вердикт

- [ ] **ACCEPT** — вариант настоящий, высокая уверенность
- [ ] **ACCEPT with caution** — скорее настоящий, но есть сомнения
- [ ] **REJECT** — скорее артефакт
- [ ] **UNCLEAR** — недостаточно данных

**Обоснование (1-2 предложения):**

### 5. Предложение фильтра

Какое правило `bcftools view -i '...'` или `-e '...'` подошло бы:

```bash
bcftools view -i '...'
```

**Примеры фильтров:**
- Включить хорошие: `-i 'QUAL>=30 && INFO/DP>=20 && INFO/SAP<20'`
- Исключить плохие: `-e 'QUAL<20 || INFO/DP<10 || INFO/SAP>20'`

---

## Вариант 3

### 1. Позиция и основные данные

- **CHROM:POS:**
- **REF → ALT:**
- **Тип:** SNP / insertion / deletion
- **QUAL:**
- **DP:**
- **AO / RO:**
- **SAF / SAR:**
- **SAP:**
- **MQM:**

### 2. Доказательства ЗА (вариант настоящий)

1.
2.
3.

### 3. Доказательства ПРОТИВ (вариант = артефакт)

1.
2.

### 4. Вердикт

- [ ] **ACCEPT** — вариант настоящий, высокая уверенность
- [ ] **ACCEPT with caution** — скорее настоящий, но есть сомнения
- [ ] **REJECT** — скорее артефакт
- [ ] **UNCLEAR** — недостаточно данных

**Обоснование (1-2 предложения):**

### 5. Предложение фильтра

```bash
bcftools view -i '...'
```

---

## Вариант 4

### 1. Позиция и основные данные

- **CHROM:POS:**
- **REF → ALT:**
- **Тип:** SNP / insertion / deletion
- **QUAL:**
- **DP:**
- **AO / RO:**
- **SAF / SAR:**
- **SAP:**
- **MQM:**

### 2. Доказательства ЗА (вариант настоящий)

1.
2.
3.

### 3. Доказательства ПРОТИВ (вариант = артефакт)

1.
2.

### 4. Вердикт

- [ ] **ACCEPT** — вариант настоящий, высокая уверенность
- [ ] **ACCEPT with caution** — скорее настоящий, но есть сомнения
- [ ] **REJECT** — скорее артефакт
- [ ] **UNCLEAR** — недостаточно данных

**Обоснование (1-2 предложения):**

### 5. Предложение фильтра

```bash
bcftools view -i '...'
```

---

## Вариант 5

### 1. Позиция и основные данные

- **CHROM:POS:**
- **REF → ALT:**
- **Тип:** SNP / insertion / deletion
- **QUAL:**
- **DP:**
- **AO / RO:**
- **SAF / SAR:**
- **SAP:**
- **MQM:**

### 2. Доказательства ЗА (вариант настоящий)

1.
2.
3.

### 3. Доказательства ПРОТИВ (вариант = артефакт)

1.
2.

### 4. Вердикт

- [ ] **ACCEPT** — вариант настоящий, высокая уверенность
- [ ] **ACCEPT with caution** — скорее настоящий, но есть сомнения
- [ ] **REJECT** — скорее артефакт
- [ ] **UNCLEAR** — недостаточно данных

**Обоснование (1-2 предложения):**

### 5. Предложение фильтра

```bash
bcftools view -i '...'
```

---

## Общий вывод (3-5 предложений)

- **Самые надёжные варианты и почему:**
- **Варианты с наибольшими сомнениями:**
- **Единый фильтр для всего VCF:** (какое правило `bcftools view` вы бы применили)

---

## Где найти файлы

```
variant_calling/
├── outputs/
│   └── run_YYYYMMDD_HHMMSS/      ← Ваша папка с результатами
│       ├── variants/
│       │   ├── raw.vcf.gz         ← Все варианты (до фильтрации)
│       │   └── filtered.vcf.gz    ← После фильтров
│       └── stats/
│           └── stats.txt
├── data/input/
│   └── reads_sorted.bam           ← BAM для проверки покрытия
└── homework/
    └── submissions/$GITHUB_USER/
        └── variants_$GITHUB_USER.txt  ← Ваши 5 assigned вариантов
```

---

## Как извлечь данные

**Найти вашу папку с результатами:**
```bash
OUTDIR=$(ls -td outputs/run_* | head -1)
echo $OUTDIR
```

**Полная строка VCF для конкретной позиции:**
```bash
# Пример: посмотреть вариант на позиции 123456
bcftools view $OUTDIR/variants/raw.vcf.gz NC_000964.3:123456-123456
```

**Извлечь ключевые поля (одна строка, удобно для анализа):**
```bash
# Все важные метрики в одну строку
bcftools query -f '%CHROM\t%POS\t%REF\t%ALT\t%QUAL\t%INFO/DP\t%INFO/AO\t%INFO/RO\t%INFO/SAF\t%INFO/SAR\t%INFO/SRP\t%INFO/SAP\t%INFO/MQM\t%INFO/RPP\n' \
    $OUTDIR/variants/raw.vcf.gz \
    -r NC_000964.3:123456-123456
```

**Проверить покрытие в позиции:**
```bash
# Для проверки DP из BAM
samtools depth data/input/reads_sorted.bam -r NC_000964.3:123456-123456
```

**Извлечь все 5 ваших assigned вариантов:**
```bash
# Прочитать список позиций
cat homework/submissions/$GITHUB_USER/variants_$GITHUB_USER.txt

# Извлечь данные для всех позиций из списка
while read pos; do
  bcftools query -f '%CHROM\t%POS\t%REF\t%ALT\t%QUAL\t%INFO/DP\t%INFO/AO\t%INFO/RO\t%INFO/SAF\t%INFO/SAR\t%INFO/SAP\t%INFO/MQM\n' \
    $OUTDIR/variants/raw.vcf.gz -r "$pos"
done < homework/submissions/$GITHUB_USER/variants_$GITHUB_USER.txt
```

**Справочник полей:** См. `docs/vcf_glossary.md` для подробного описания всех INFO-полей freebayes.

---

## Типичные ошибки (избегайте)

❌ **Смотреть только на QUAL, игнорируя strand bias (SAP) и качество маппинга (MQM)** — QUAL может быть высоким даже для артефакта с сильным strand bias

❌ **Не проверять баланс ALT/REF прочтений (AO/DP)** — для гаплоида ожидаем ~100%, если AO/DP < 70%, это подозрительно

❌ **Предлагать нереалистичные фильтры** — `QUAL>500` слишком строгий (отсечёт хорошие варианты), `QUAL>1` слишком мягкий (пропустит артефакты)

❌ **Копировать одинаковые вердикты для всех вариантов без анализа** — каждый вариант индивидуален, анализируйте метрики отдельно

❌ **Забывать заполнять секцию "Доказательства ПРОТИВ"** — даже для ACCEPT вариантов проверьте потенциальные проблемы (может, их нет, но нужно проверить)

❌ **Игнорировать тип варианта (SNP vs indel)** — indel обычно имеют более низкий QUAL и требуют более внимательной проверки

---

## Связь с реальной практикой

В реальных проектах variant calling результаты обычно проходят:

1. **Автоматическая фильтрация** (bcftools, GATK) — отсекает очевидные артефакты по жёстким порогам
2. **Ручная проверка** (человек смотрит в VCF/BAM) — **именно это вы делаете в HW2**
3. **Валидация** (Sanger-секвенирование, независимая технология) — подтверждение критичных вариантов

Ваша задача — научиться делать шаг 2 осознанно и с пониманием метрик качества. В клинической практике (диагностика, персонализированная медицина) или при публикации данных ручная проверка обязательна.

**Важно:** VCF — это модель, а не реальность. Метрики помогают оценить уверенность, но окончательное решение требует биологического контекста и здравого смысла.

---

## Полезные ссылки

- **Полное задание:** `docs/homework_02.md`
- **Справочник VCF:** `docs/vcf_glossary.md`
- **Термины:** `docs/glossary.md`
- **Команды:** `docs/cheatsheet.md`
- **Ожидаемые результаты:** `docs/expected_outputs.md`
- **Проблемы:** `docs/troubleshooting.md`
