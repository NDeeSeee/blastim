# Домашнее задание 2 (~90 минут): Variant Defense

**Организм:** *Bacillus subtilis* 168 (модельный штамм)

> **Справочник:** См. `docs/vcf_glossary.md` для подробного описания всех полей VCF и метрик freebayes.

## Цель

После запуска пайплайна (freebayes → bcftools filter → stats) нужно вынести вердикт по 5 персональным вариантам: настоящий вариант или артефакт секвенирования.

Это задача, которую реально выполняют в лаборатории при ручной проверке результатов variant calling перед публикацией или клиническим использованием.

---

## Как сдаём (Git-практика)

1. Сделайте **fork** репозитория преподавателя к себе в GitHub.
2. Клонируйте свой fork, создайте ветку:
   ```bash
   git checkout -b hw2-<github_username>
   ```
3. Запустите назначение персональных вариантов:
   ```bash
   export GITHUB_USER=<ваш_github_username>
   python scripts/90_homework_assign_variants.py \
     --vcf outputs/<ваш_run_папка>/variants/raw.vcf.gz \
     --out homework/submissions/$GITHUB_USER/variants_$GITHUB_USER.txt
   ```
4. Скопируйте шаблон в свою папку:
   ```bash
   mkdir -p homework/submissions/$GITHUB_USER
   cp homework/TEMPLATE_variant_defense.md \
      homework/submissions/$GITHUB_USER/defense_$GITHUB_USER.md
   ```
5. Заполните файл (5 вариантов × 5 секций), затем:
   ```bash
   git add homework/submissions/$GITHUB_USER/
   git commit -m "HW2: $GITHUB_USER"
   git push origin hw2-$GITHUB_USER
   ```
6. Откройте **Pull Request** в основной репозиторий преподавателя.

---

## Индивидуализация

Каждому студенту назначается персональный набор из **5 вариантов** (детерминированно по GitHub username). Скрипт `90_homework_assign_variants.py` выбирает сбалансированный набор:

- **1-2 надёжных SNP** (QUAL > 100, DP > 20) — должны быть ACCEPT
- **1 indel** (QUAL > 50) — обычно сложнее оценить
- **1-2 пограничных/низкокачественных** (QUAL < 30 или DP < 10) — кандидаты на REJECT

---

## Задание: Variant Defense

**Файл для сдачи:** `homework/submissions/<user>/defense_<user>.md`

Для каждого из 5 назначенных вариантов заполните все 5 секций:

### 1. Позиция и основные данные
- **CHROM:POS**, REF → ALT
- **QUAL**, DP, AO, RO
- **Тип:** SNP / insertion / deletion

### 2. Доказательства ЗА (вариант настоящий)

Перечислите факты, которые **поддерживают**, что вариант настоящий:

- **Высокий QUAL?** (>= 30 — минимум, >= 100 — уверенно)
- **Достаточная глубина?** (DP >= 10 — минимум, >= 20 — уверенно)
- **Баланс прочтений ALT по цепям?** (SAP < 20 — хорошо; SAF и SAR примерно равны)
- **Частота ALT аллеля?** (AO/DP; для гаплоида ожидаем ~100%, но допустимо 70-100%)
- **Качество маппинга?** (MQM >= 20 — хорошо)

### 3. Доказательства ПРОТИВ (вариант = артефакт)

Перечислите факты, которые **указывают на артефакт**:

- **Низкий QUAL?** (< 20 — плохо)
- **Strand bias?** (SAP > 20 — все ALT-прочтения с одной цепи, подозрительно)
- **Position bias?** (RPP > 20 — ALT-прочтения скучкованы в одной части прочтения)
- **Низкий mapping quality?** (MQM < 20 — прочтения плохо выровнены)
- **Слишком низкая или слишком высокая глубина?** (DP < 5 — мало данных; DP > 200 — возможная дупликация/повтор)
- **Вблизи другого варианта?** (Proximity to indel может вызывать ошибки выравнивания)

### 4. Вердикт

Выберите **один** из 4 вариантов и поставьте X в чекбокс:

- [ ] **ACCEPT** — вариант настоящий, высокая уверенность
- [ ] **ACCEPT with caution** — скорее настоящий, но есть небольшие сомнения
- [ ] **REJECT** — скорее артефакт, не прошёл бы ручную проверку
- [ ] **UNCLEAR** — недостаточно данных или противоречивые доказательства

**Обоснование (1-2 предложения):** Почему вы выбрали этот вердикт, какие метрики были решающими?

### 5. Предложение фильтра

Какое правило `bcftools view -i '...'` или `-e '...'` отделило бы этот вариант от артефактов?

**Примеры:**
- `-i 'QUAL>=30 && INFO/DP>=20 && INFO/SAP<20'` (включить хорошие)
- `-e 'QUAL<20 || INFO/DP<10'` (исключить плохие)

---

## Где найти файлы и данные

### Расположение файлов

```
variant_calling/
├── outputs/
│   └── run_YYYYMMDD_HHMMSS/    ← Ваша папка с результатами
│       ├── variants/
│       │   ├── raw.vcf.gz       ← Все варианты до фильтрации
│       │   └── filtered.vcf.gz  ← После фильтров
│       └── stats/
│           └── stats.txt
├── data/
│   └── input/
│       └── reads_sorted.bam     ← BAM для проверки покрытия
└── homework/
    └── submissions/$GITHUB_USER/
        └── variants_$GITHUB_USER.txt  ← Ваши assigned варианты
```

### Как извлечь данные для анализа

```bash
# Найти свою папку с результатами
OUTDIR=$(ls -td outputs/run_* | head -1)
echo $OUTDIR

# Полная строка VCF для конкретной позиции
bcftools view $OUTDIR/variants/raw.vcf.gz NC_000964.3:12345-12345

# Ключевые поля (одна строка, удобно)
bcftools query -f '%CHROM\t%POS\t%REF\t%ALT\t%QUAL\t%INFO/DP\t%INFO/AO\t%INFO/RO\t%INFO/SAF\t%INFO/SAR\t%INFO/SRP\t%INFO/SAP\t%INFO/MQM\n' \
    $OUTDIR/variants/raw.vcf.gz \
    -r NC_000964.3:12345-12345

# Покрытие в позиции (для проверки DP)
samtools depth data/input/reads_sorted.bam -r NC_000964.3:12345-12345
```

**Справочник полей:** `docs/vcf_glossary.md` — подробное описание всех INFO-полей freebayes.

---

## Пример (для ориентира)

### Вариант 1: NC_000964.3:123456 G→A

**1. Позиция и основные данные:**
- CHROM:POS: NC_000964.3:123456
- REF→ALT: G→A
- QUAL: 245.6, DP: 35, AO: 34, RO: 1
- Тип: SNP

**2. Доказательства ЗА:**
- QUAL очень высокий (245 >> 30)
- DP адекватная (35, в диапазоне 10-200)
- Частота ALT: 34/35 = 97% (ожидаемо для гаплоида)
- SAP: 3.2 (< 20, нет strand bias)
- MQM: 60 (отличное качество маппинга)

**3. Доказательства ПРОТИВ:**
- Нет значимых фактов против

**4. Вердикт:**
- [X] **ACCEPT** — вариант настоящий, высокая уверенность

**Обоснование:** Все метрики указывают на настоящий SNP: высокий QUAL, нормальная глубина, почти 100% ALT прочтений, нет strand bias.

**5. Предложение фильтра:**
```
-i 'QUAL>=100 && INFO/DP>=20 && INFO/SAP<20'
```

---

## Самопроверка (опционально)

```bash
python scripts/91_homework_check.py --user $GITHUB_USER
```

Скрипт проверит:
- Файлы `variants_<user>.txt` и `defense_<user>.md` существуют
- Содержат ключевые слова: "QUAL", "DP", "ACCEPT", "REJECT", "bcftools"

Или через Make:

```bash
make homework-check
```

---

## Критерии оценивания (5 баллов)

| Балл | Критерий |
|------|----------|
| **1** | Корректное извлечение данных из VCF (QUAL, DP, AO/RO, SAP, MQM) для всех 5 вариантов |
| **2** | Логичная аргументация ЗА и ПРОТИВ — используются минимум 3 метрики на вариант |
| **3** | Вердикт обоснован и согласуется с приведёнными доказательствами (нет противоречий) |
| **4** | Предложенные фильтры конкретные, применимые и соответствуют вердикту |
| **5** | Отчёт понятный, структурированный, легко читается — все секции заполнены |

### Типичные ошибки (избегайте):

- ❌ Смотреть только на QUAL, игнорируя strand bias (SAP) и качество маппинга (MQM)
- ❌ Не проверять баланс ALT/REF прочтений (AO/DP) — важно для гаплоидов
- ❌ Предлагать нереалистичные фильтры (например, `QUAL>500`) или слишком мягкие (`QUAL>1`)
- ❌ Копировать одинаковые вердикты для всех вариантов без анализа
- ❌ Забывать заполнять секцию "Доказательства ПРОТИВ" (даже для ACCEPT вариантов проверьте потенциальные проблемы)

---

## Часто задаваемые вопросы

**Q: Где найти значения SAP, MQM, RPP и других INFO-полей?**

A: В VCF-файле в колонке INFO. Используйте команду:
```bash
bcftools query -f '%INFO/SAP\t%INFO/MQM\t%INFO/RPP\n' \
    outputs/run_*/variants/raw.vcf.gz -r NC_000964.3:12345-12345
```
Или смотрите `docs/vcf_glossary.md` для описания всех полей.

**Q: Что делать, если вариант пограничный (например, QUAL=25, DP=15)?**

A: Используйте вердикт **ACCEPT with caution** или **UNCLEAR**. Объясните, какие метрики хорошие, какие плохие, и почему решение неоднозначно.

**Q: Сколько времени это займёт?**

A: Примерно 90 минут для первого раза. По 15-20 минут на вариант (извлечь данные, проанализировать, написать вердикт).

**Q: Можно ли использовать `filtered.vcf.gz` вместо `raw.vcf.gz`?**

A: Нет, используйте `raw.vcf.gz`. Задача — самостоятельно оценить варианты, включая те, что не прошли автоматические фильтры.

**Q: Как понять, что такое "strand bias" практически?**

A: Если SAF=20, SAR=0 (все ALT-прочтения только с forward цепи), это strand bias. Настоящие варианты обычно видны на обеих цепях. SAP > 20 указывает на сильный bias.

**Q: Что если все мои варианты имеют высокий QUAL?**

A: Это нормально — скрипт назначения специально даёт 1-2 надёжных варианта. Но проверьте и другие метрики (strand bias, mapping quality), даже для хороших вариантов могут быть проблемы.

**Q: Нужно ли смотреть на BAM-файл в IGV?**

A: Опционально. Для этого задания достаточно метрик из VCF. Но если хотите углубиться, можете визуально проверить выравнивание в IGV.

---

## Дополнительные материалы

- **docs/vcf_glossary.md** — полный справочник VCF-полей
- **docs/glossary.md** — термины и концепции (Ti/Tv, QUAL, strand bias)
- **docs/cheatsheet.md** — команды bcftools для работы с VCF
- **docs/troubleshooting.md** — решение частых проблем

---

## Связь с реальной практикой

В реальных проектах variant calling результаты обычно проходят:
1. **Автоматическая фильтрация** (bcftools, GATK) — отсекает очевидные артефакты
2. **Ручная проверка** (человек смотрит в VCF/BAM) — именно это вы делаете в HW2
3. **Валидация** (Sanger-секвенирование, независимая технология) — подтверждение критичных вариантов

Ваша задача — научиться делать шаг 2 осознанно и с пониманием метрик качества.
