# Глоссарий: поиск геномных вариантов

Ключевые термины, концепции и инструменты, используемые в практикуме.

---

## Термины

### Биологические

| Термин | Определение |
|--------|------------|
| **SNP** (Single Nucleotide Polymorphism) | Однонуклеотидный полиморфизм — замена одного нуклеотида. Самый частый тип геномных вариантов |
| **InDel** (Insertion/Deletion) | Вставка или делеция одного или нескольких нуклеотидов |
| **MNP** (Multi-Nucleotide Polymorphism) | Замена нескольких соседних нуклеотидов одновременно |
| **Аллель** | Конкретный вариант нуклеотидной последовательности в данной позиции. REF — референсный аллель, ALT — альтернативный |
| **Генотип** | Набор аллелей в данной позиции. Для гаплоида: `0` (REF) или `1` (ALT). Для диплоида: `0/0`, `0/1`, `1/1` |
| **Плоидность** | Число копий генома в клетке. Бактерии — 1 (гаплоид), человек — 2 (диплоид) |
| **Гетерозигота** | Позиция с двумя разными аллелями (только для диплоидов и выше). Генотип `0/1` |
| **Гомозигота** | Позиция с двумя одинаковыми аллелями. Генотип `0/0` (по REF) или `1/1` (по ALT) |
| **Транзиция (Ti)** | Замена пурина на пурин (A↔G) или пиримидина на пиримидин (C↔T). Встречается чаще трансверсий |
| **Трансверсия (Tv)** | Замена пурина на пиримидин или наоборот (A↔C, A↔T, G↔C, G↔T) |
| **Ti/Tv ratio** | Отношение числа транзиций к трансверсиям. Для реальных SNP обычно ~2.0-2.5. Низкий Ti/Tv может указывать на артефакты |

### Биоинформатические

| Термин | Определение |
|--------|------------|
| **Variant calling** | Процесс обнаружения геномных вариантов путём сравнения прочтений с референсным геномом |
| **Покрытие (coverage/depth)** | Среднее число прочтений, перекрывающих каждую позицию генома. 50x = каждая позиция покрыта в среднем 50 прочтениями |
| **QUAL** (Phred-scaled quality) | Оценка качества варианта: QUAL = -10 × log₁₀(P(ошибка)). QUAL=20 → 1% ошибка, QUAL=30 → 0.1% |
| **DP** (Depth) | Глубина покрытия в конкретной позиции. Слишком низкий DP — мало данных, слишком высокий — возможный артефакт (дупликация, повтор) |
| **AO / RO** | Число прочтений, поддерживающих ALT (Alternate Observation) и REF (Reference Observation) |
| **Strand bias** | Смещение прочтений ALT-аллеля на одну цепь ДНК. Сильный strand bias (SAP > 20) — признак артефакта секвенирования |
| **Mapping quality (MAPQ)** | Качество выравнивания прочтения на геном. MAPQ=0 означает, что прочтение выравнивается на несколько позиций одинаково хорошо |
| **Hard filtering** | Фильтрация вариантов по фиксированным порогам (QUAL, DP и т.д.). Простая, но грубая |
| **Soft filtering** | Пометка вариантов тегом в поле FILTER, но без удаления из файла. Позволяет пересмотреть решение позже |
| **Ложноположительный** (false positive) | Вариант, вызванный ошибкой секвенирования или выравнивания, а не реальной мутацией |
| **Ложноотрицательный** (false negative) | Реальный вариант, пропущенный при variant calling (из-за низкого покрытия, плохого выравнивания и т.д.) |

### Форматы данных

| Формат | Описание |
|--------|----------|
| **FASTA** | Текстовый формат для нуклеотидных/белковых последовательностей. Заголовок начинается с `>` |
| **FASTQ** | FASTA + качество каждого нуклеотида (Phred-score). Стандартный формат данных секвенирования |
| **SAM** | Sequence Alignment/Map — текстовый формат выравниваний прочтений на геном |
| **BAM** | Бинарная (сжатая) версия SAM. Требует индекса (.bai) для произвольного доступа |
| **VCF** | Variant Call Format — стандартный формат для описания геномных вариантов. См. раздел "VCF формат" ниже для деталей |
| **bgzip** | Block-gzip — формат сжатия с поддержкой произвольного доступа. Внешне похож на gzip, но позволяет индексирование через tabix |

---

## VCF формат

VCF (Variant Call Format) — стандартизированный текстовый формат для представления геномных вариантов. Каждая строка описывает один вариант в одной позиции.

### Фиксированные поля (8 обязательных столбцов)

| Поле | Описание | Пример |
|------|----------|--------|
| **CHROM** | Название хромосомы/контига | `NC_000964.3`, `chr1`, `contig_1` |
| **POS** | Позиция варианта (1-based) | `123456` |
| **ID** | Идентификатор варианта (dbSNP ID, и т.д.) | `rs12345`, `.` (если нет) |
| **REF** | Референсный аллель (нуклеотид(ы) в референсе) | `A`, `GAT` |
| **ALT** | Альтернативный аллель (наблюдаемая замена) | `G`, `GATC`, `A,C` (multi-allelic) |
| **QUAL** | Phred-scaled quality score: -10×log₁₀(P(ошибка)) | `245.6` (вероятность ошибки 10⁻²⁴·⁵⁶) |
| **FILTER** | Статус фильтрации: `PASS` или причина отклонения | `PASS`, `LowQual`, `StrandBias`, `.` |
| **INFO** | Дополнительные аннотации (ключ=значение, разделены `;`) | `DP=35;AF=0.97;SAP=3.2` |

### Дополнительные поля (опциональные)

| Поле | Описание | Когда присутствует |
|------|----------|-------------------|
| **FORMAT** | Формат генотипа (какие поля для каждого образца) | `GT:DP:GQ` (генотип:глубина:качество) |
| **Sample1, Sample2, ...** | Данные по образцам (по формату FORMAT) | `1:35:99` (ALT, глубина 35, качество 99) |

### Общие INFO-теги (стандарт VCF)

| Тег | Расшифровка | Описание |
|-----|-------------|----------|
| **DP** | Total Depth | Общая глубина покрытия в позиции (все прочтения) |
| **AF** | Allele Frequency | Частота аллеля: 0.0-1.0. Для гаплоида: 0 (REF) или 1 (ALT) |
| **AC** | Allele Count | Число хромосом с ALT аллелем |
| **AN** | Allele Number | Общее число хромосом в выборке |
| **NS** | Number of Samples | Число образцов с данными в этой позиции |
| **DB** | dbSNP membership | Вариант присутствует в базе dbSNP |
| **H2** | HapMap2 membership | Вариант валидирован в проекте HapMap |

### Общие FORMAT-теги (генотип per-sample)

| Тег | Расшифровка | Описание | Пример |
|-----|-------------|----------|--------|
| **GT** | Genotype | Генотип: `0/0` (REF/REF), `0/1` (REF/ALT), `1/1` (ALT/ALT), `1` (гаплоид ALT) | `0/1` |
| **DP** | Read Depth | Глубина прочтений для этого образца | `28` |
| **GQ** | Genotype Quality | Phred-scaled качество генотипа | `99` |
| **AD** | Allelic Depth | Глубина для REF и ALT: REF_depth,ALT_depth | `12,16` |
| **PL** | Phred-scaled Likelihoods | Логарифмические likelihood'ы для всех генотипов (0/0, 0/1, 1/1) | `0,45,600` |
| **GL** | Genotype Likelihoods | Likelihood'ы в log₁₀ формате | `-0.48,-1.2,-5.3` |

### Freebayes-специфичные INFO-поля

Freebayes добавляет богатый набор метрик качества. **Полный справочник:** см. `vcf_glossary.md`

| Тег | Описание | Интерпретация |
|-----|----------|---------------|
| **AO** | Alternate Observation count | Число прочтений, поддерживающих ALT |
| **RO** | Reference Observation count | Число прочтений, поддерживающих REF |
| **SAF/SAR** | Strand ALT Forward/Reverse | ALT прочтения на forward/reverse цепи |
| **SAP** | Strand balance probability (ALT) | Phred-scaled P(strand bias). >20 → подозрительно |
| **SRP** | Strand balance probability (REF) | То же для REF аллеля |
| **MQM** | Mean Mapping Quality (ALT) | Среднее качество маппинга ALT прочтений. <20 → плохо |
| **MQMR** | Mean Mapping Quality (REF) | Среднее качество маппинга REF прочтений |
| **RPP** | Read Position bias probability | P(position bias): скучкованы ли ALT прочтения в одной части read'а |

---

## Концепции

### Почему нужна фильтрация

Variant caller'ы намеренно вызывают больше вариантов, чем есть на самом деле (высокая чувствительность). Задача фильтрации — убрать артефакты, сохранив настоящие варианты. Основные фильтры:
- **QUAL** — уверенность caller'а в варианте. Низкий QUAL → мало статистических доказательств
- **DP** — слишком низкий = мало данных, слишком высокий = возможный артефакт (повтор, дупликация)
- **Strand bias** — если все прочтения ALT с одной цепи, вероятен артефакт секвенирования

### Ti/Tv ratio как контроль качества

Транзиции (A↔G, C↔T) происходят чаще трансверсий по биохимическим причинам. Ожидаемый Ti/Tv:
- Для WGS данных: ~2.0-2.5
- Для экзомных данных: ~2.8-3.2

Если Ti/Tv < 1.5 — в данных много ложноположительных вариантов (артефакты не имеют биологического смещения в сторону транзиций). Это простой и мощный индикатор качества.

### bgzip ≠ gzip

Обычный gzip сжимает файл целиком — для чтения нужно распаковать всё. bgzip сжимает блоками по 64 КБ, что позволяет tabix находить нужный регион без распаковки всего файла. Это критично для больших VCF/BAM: запрос «покажи варианты на chr1:100000-200000» выполняется за миллисекунды, а не минуты.

### Haplotype-based vs pileup-based calling

Два основных подхода к поиску вариантов:
- **Pileup-based** (bcftools mpileup/call) — смотрит на каждую позицию независимо. Быстрый, но может пропускать сложные варианты
- **Haplotype-based** (freebayes, GATK HaplotypeCaller) — рассматривает локальные гаплотипы (комбинации близких вариантов). Точнее для indel'ов и сложных вариантов, но медленнее

В этом практикуме мы используем freebayes (haplotype-based), потому что он даёт богатые INFO-поля (AO, RO, SRP, SAP) для учебного анализа.

### Что означают поля freebayes

freebayes записывает в VCF больше информации, чем минимально требуется:
- **AO/RO** — число прочтений за ALT/REF. Позволяет вычислить наблюдаемую частоту аллеля: AO/(AO+RO)
- **SAF/SAR** — прочтения ALT на forward/reverse цепи. Если SAF=20, SAR=0 — сильный strand bias
- **SRP/SAP** — Phred-scaled вероятность strand bias для REF/ALT. SAP > 20 → P(bias) < 0.01
- **RPP/RPL/RPR** — position bias: распределение ALT-прочтений по позиции вдоль прочтения
- **MQM/MQMR** — среднее качество маппинга для ALT/REF прочтений

---

## Инструменты

### Variant Callers (инструменты поиска вариантов)

#### freebayes ⭐ (используется в практикуме)

| | |
|---|---|
| **Что делает** | Bayesian haplotype-based variant caller. Находит SNP, InDel, MNP и сложные варианты |
| **Подход** | Haplotype-based: рассматривает комбинации близких вариантов, строит локальные гаплотипы |
| **Вход** | BAM (выравнивание) + FASTA (референс) |
| **Выход** | VCF с богатыми INFO-полями (AO, RO, SAF, SAR, SAP, MQM, RPP) |
| **Плоидность** | Поддерживает любую плоидность (1-N). Задаётся флагом `--ploidy` |
| **Преимущества** | Богатые метрики качества, простая установка, работает «из коробки», открытый код |
| **Недостатки** | Однопоточный (медленнее на больших геномах). Для ускорения используют `freebayes-parallel` |
| **Почему в практикуме** | Идеально для обучения: подробные INFO-поля позволяют понять, почему вариант вызван |
| **Цитировать** | Garrison & Marth (2012). arXiv:1207.3907 |

#### GATK HaplotypeCaller

| | |
|---|---|
| **Что делает** | Индустриальный стандарт variant calling от Broad Institute. Часть GATK (Genome Analysis Toolkit) |
| **Подход** | Haplotype-based с локальной реассемблировкой de novo |
| **Вход** | BAM + FASTA. Требует предварительной подготовки: BQSR (Base Quality Score Recalibration), DuplicateMarking |
| **Выход** | gVCF (промежуточный формат) или финальный VCF |
| **Плоидность** | Поддерживает разную плоидность, включая смешанные (например, X хромосома у мужчин) |
| **Преимущества** | Очень точный для человека (оптимизирован на данных 1000 Genomes, gnomAD). Активное развитие |
| **Недостатки** | Сложный пайплайн (BQSR, VQSR). Требует больше ресурсов. Java (медленный старт) |
| **Best Practices** | GATK Best Practices pipeline — золотой стандарт для клинических данных |
| **Лицензия** | BSD-3-Clause (открытый код с 2019), ранее была проприетарной |

#### bcftools mpileup/call

| | |
|---|---|
| **Что делает** | Быстрый pileup-based variant caller |
| **Подход** | Pileup: смотрит на каждую позицию независимо, считает вероятности генотипов |
| **Вход** | BAM + FASTA |
| **Выход** | VCF/BCF (бинарный формат VCF) |
| **Плоидность** | Гибкая настройка через параметры |
| **Преимущества** | Очень быстрый, простой, часть популярного пакета bcftools |
| **Недостатки** | Хуже справляется со сложными indel'ами (нет локальной реассемблировки) |
| **Когда использовать** | Для быстрого первичного анализа, бактериальных геномов, low-coverage данных |
| **Предшественник** | samtools mpileup (старый, больше не рекомендуется) |

#### DeepVariant (Google)

| | |
|---|---|
| **Что делает** | Deep learning variant caller — использует сверточные нейронные сети (CNN) |
| **Подход** | Преобразует выравнивание в "картинку" (pileup image), CNN классифицирует генотипы |
| **Вход** | BAM + FASTA |
| **Выход** | VCF с высокой точностью |
| **Плоидность** | Оптимизирован для диплоидов, но гибко настраивается |
| **Преимущества** | Очень высокая точность (особенно для Illumina WGS). Не требует ручной настройки порогов |
| **Недостатки** | Требует GPU для разумной скорости. "Чёрный ящик" — сложно интерпретировать ошибки |
| **Когда использовать** | Для клинических данных человека (WGS/WES) при наличии GPU |
| **Модели** | Pretrained models для Illumina WGS, WES, PacBio HiFi |
| **Цитировать** | Poplin et al. (2018). Nature Biotechnology 36:983-987 |

#### Strelka2 (Illumina)

| | |
|---|---|
| **Что делает** | Быстрый и точный caller для germline и somatic вариантов |
| **Подход** | Haplotype-based с оптимизацией для скорости |
| **Вход** | BAM + FASTA. Для somatic: tumor BAM + normal BAM |
| **Выход** | VCF для SNV и отдельный для indel |
| **Плоидность** | Поддерживает различную плоидность |
| **Преимущества** | Очень быстрый (в 10-40× быстрее GATK). Хорошая точность для somatic variants |
| **Недостатки** | Меньше INFO-полей чем freebayes. Сложнее в установке |
| **Когда использовать** | Для больших когорт (WGS), cancer genomics (tumor-normal пары) |
| **Цитировать** | Kim et al. (2018). Nature Methods 15:591-594 |

#### VarScan2

| | |
|---|---|
| **Что делает** | Heuristic variant caller с акцентом на соматические варианты и low-frequency аллели |
| **Подход** | Pileup-based с порогами на частоты аллелей |
| **Вход** | samtools mpileup → VarScan |
| **Выход** | VCF |
| **Плоидность** | Настраивается |
| **Преимущества** | Хорошо находит low-frequency варианты (до 1% частоты). Простые и понятные параметры |
| **Недостатки** | Старый (2009-2012), меньше развивается. Хуже точность по сравнению с современными ML подходами |
| **Когда использовать** | Для cancer genomics (ctDNA, tumor heterogeneity), pooled sequencing |
| **Цитировать** | Koboldt et al. (2012). Genome Research 22:568-576 |

#### Octopus

| | |
|---|---|
| **Что делает** | Современный Bayesian haplotype-based caller с поддержкой complex variants |
| **Подход** | Haplotype-based с графами вариантов |
| **Вход** | BAM + FASTA. Поддерживает linked-reads, trio calling |
| **Выход** | VCF с подробными аннотациями |
| **Плоидность** | Произвольная плоидность, включая mosaicism, somatic |
| **Преимущества** | Очень гибкий (поддерживает сложные сценарии: trio, cancer, mosaicism). Хорошая точность |
| **Недостатки** | Менее популярен чем GATK/freebayes. Медленнее на больших геномах |
| **Когда использовать** | Для сложных случаев: de novo мутации в trio, complex structural variants, cancer |
| **Цитировать** | Cooke et al. (2021). Nature Biotechnology 39:1202-1213 |

#### Сравнение подходов

| Критерий | Haplotype-based (freebayes, GATK, Octopus) | Pileup-based (bcftools, VarScan) | Deep Learning (DeepVariant) |
|----------|---------------------------------------------|----------------------------------|----------------------------|
| **Скорость** | Средняя/медленная | Быстрая | Средняя (с GPU) |
| **Точность для SNV** | Высокая | Хорошая | Очень высокая |
| **Точность для indel** | Высокая | Средняя | Высокая |
| **Интерпретируемость** | Хорошая (Bayesian логика) | Хорошая | Низкая ("чёрный ящик") |
| **Требования к памяти** | Средние/высокие | Низкие | Очень высокие (GPU) |
| **Настройка** | Гибкая | Простая | Минимальная |

### bcftools

| | |
|---|---|
| **Что делает** | Универсальный инструментарий для работы с VCF/BCF: фильтрация, статистика, запросы, конвертация |
| **Ключевые команды** | `view` — фильтрация и конвертация. `stats` — статистика (SNP/indel, Ti/Tv). `query` — извлечение данных в произвольном формате. `filter` — soft-filtering (пометка тегом) |
| **Почему bcftools** | Стандарт де-факто для работы с VCF. Быстрый, гибкий, хорошо документированный |
| **Альтернативы** | **GATK** — для сложных пайплайнов. **vcftools** — устаревший, но ещё используется |

### samtools

| | |
|---|---|
| **Что делает** | Работа с SAM/BAM/CRAM: сортировка, индексирование, статистика, pileup |
| **Ключевые команды** | `sort` — сортировка BAM по координатам. `index` — создание .bai индекса. `flagstat` — статистика выравнивания. `depth` — глубина покрытия. `faidx` — индексирование FASTA |
| **Почему samtools** | Стандарт для работы с BAM. Необходим для подготовки данных перед variant calling |

### BWA

| | |
|---|---|
| **Что делает** | Выравнивание коротких прочтений на референсный геном (Burrows-Wheeler Aligner) |
| **Ключевая команда** | `bwa mem` — выравнивание парных прочтений (основной алгоритм для Illumina 70-300bp) |
| **Почему BWA** | Стандарт для коротких прочтений. Быстрый, точный, широко используется в пайплайнах |
| **Альтернативы** | **Bowtie2** — альтернативный выравниватель. **minimap2** — для длинных прочтений (PacBio, Nanopore) |

### Вспомогательные инструменты

| Инструмент | Назначение |
|------------|-----------|
| **bgzip** (htslib) | Block-gzip сжатие VCF с поддержкой произвольного доступа |
| **tabix** (htslib) | Создание индексов для bgzip-сжатых VCF/BED/GFF — позволяет запросы по регионам |
| **wgsim** (samtools) | Симулятор коротких прочтений из референсного генома. Используется для создания тестовых данных с известными мутациями |
| **seqkit** | Быстрая работа с FASTA/FASTQ: статистика, фильтрация, извлечение последовательностей |
