# Руководство преподавателя

Как подготовить HPC, разместить данные и провести занятие по variant calling.

## Обзор

| Этап | Действие | Когда |
|------|----------|-------|
| **Подготовка** | Установить окружение, подготовить данные | За 1-2 дня до занятия |
| **Проверка** | Тестовый прогон всего рабочего процесса | За день до занятия |
| **Занятие** | Студенты выполняют шаги 10-60 | Во время 2-часового занятия |
| **Сброс** | Очистить результаты для следующей группы | После занятия |

## 1. Требования к дисковому пространству

| Компонент | Размер |
|-----------|--------|
| Conda-окружение | ~1.5 ГБ |
| Референсный геном (.fasta + индексы) | ~15 МБ |
| BAM-файл (симулированные прочтения) | ~300 МБ |
| Результаты на студента | ~20 МБ |
| **Итого** | **~2 ГБ** |

## 2. Настройка окружения

```bash
# Вариант A: micromamba (рекомендуется)
bash env/micromamba_create.sh
micromamba activate ngs-variants

# Вариант B: conda/mamba
conda env create -f env/environment.yml
conda activate ngs-variants
```

Проверьте окружение:

```bash
bash scripts/00_check_system.sh
```

Все пункты должны показывать `[OK]`, кроме предупреждений о data (их мы настроим далее).

## 3. Подготовка данных

Выполните из директории практикума (`variant_calling/`):

```bash
# Загрузка генома B. subtilis + симуляция прочтений + выравнивание
bash scripts/01_get_data.sh
```

Или через Make:

```bash
make prep-data
```

Скрипт `01_get_data.sh`:
1. Загружает референсный геном B. subtilis 168 из NCBI
2. Симулирует парные прочтения ~50x покрытия с помощью `wgsim` (seed=42)
3. Выравнивает прочтения с `bwa mem`
4. Сортирует и индексирует BAM с `samtools`
5. Сохраняет истинные мутации в `data/truth/wgsim.mutations.txt`

### Параметры симуляции

| Параметр | Значение | Описание |
|----------|----------|----------|
| `-N` | 700000 | Число пар прочтений (~50x) |
| `-1 / -2` | 150 | Длина прочтений |
| `-r` | 0.001 | Частота замен |
| `-R` | 0.15 | Доля инделов среди мутаций |
| `-e` | 0.005 | Ошибка секвенирования |
| `-S` | 42 | Seed (воспроизводимость) |

Все данные после подготовки находятся в `data/`, и репозиторий может работать офлайн.

### Офлайн-режим для занятия

Если на HPC нет интернета во время занятия:

1. Запустите `01_get_data.sh` на машине с интернетом.
2. Скопируйте данные на HPC:
   ```bash
   rsync -avP data/ hpc:/path/to/blastim_ngs/variant_calling/data/
   ```
3. Студентам нужен только репозиторий + предварительно подготовленная директория `data/`.

## 4. Тестовый прогон

Запустите полный рабочий процесс для проверки:

```bash
cp workflow/config.sh.example workflow/config.sh
bash workflow/run_all.sh
```

### Ожидаемое время выполнения (8 ядер)

| Шаг | Ожидаемое время |
|-----|-----------------|
| Подготовка референса | <1 мин |
| Валидация BAM | 1-2 мин |
| freebayes | 3-10 мин |
| bgzip + tabix | <1 мин |
| bcftools filter | <1 мин |
| bcftools stats | <1 мин |
| **Итого** | **~5-15 мин** |

### Ожидаемые результаты (приблизительно, B. subtilis 168)

| Метрика | Ожидаемый диапазон |
|---------|-------------------|
| Всего вариантов (raw) | 3 000 - 5 000 |
| SNP | 2 500 - 4 000 |
| Indel | 300 - 800 |
| Ti/Tv | 2.0 - 2.5 |
| Проходят фильтры | 70% - 85% |

Если значения существенно отличаются, проверьте версии инструментов и содержимое BAM.

## 5. Рабочий процесс студентов

Студенты должны:

1. Скопировать файл конфигурации:
   ```bash
   cp workflow/config.sh.example workflow/config.sh
   ```

2. Запустить полный рабочий процесс:
   ```bash
   bash workflow/run_all.sh
   ```

   Или пошагово (рекомендуется для обучения):
   ```bash
   bash scripts/10_prep_reference.sh
   bash scripts/11_prep_bam.sh
   bash scripts/20_call_freebayes.sh
   bash scripts/30_compress_index_vcf.sh
   bash scripts/40_filter_bcftools.sh
   bash scripts/50_stats_bcftools.sh
   bash scripts/60_pick_3_variants.sh
   ```

3. Исследовать результаты с помощью команд из `docs/cheatsheet.md`.

## 6. План Б: freebayes работает слишком долго

Если freebayes занимает слишком много времени на занятии:

### Вариант A: Ограничить по региону
```bash
# Вызывать варианты только для первых 500 Кб
freebayes --fasta-reference data/input/reference.fasta \
    --ploidy 1 --bam data/input/reads_sorted.bam \
    --region "$(head -1 data/input/reference.fasta.fai | cut -f1):1-500000" \
    > outputs/run_latest/variants/raw.vcf
```

### Вариант B: Использовать предварительно подготовленный VCF
Запустите полный процесс заранее и сохраните результаты. Студенты начинают с шага 40 (фильтрация).

## 7. Сброс между группами

```bash
make clean
```

Это удалит все директории `outputs/run_*`, но сохранит входные данные.

Для полного сброса (включая данные):
```bash
make clean-all
```

## 8. Рекомендуемый план занятия (2 часа)

| Время | Активность |
|-------|-----------|
| 0:00-0:10 | Введение: что такое variant calling? Зачем нужен? |
| 0:10-0:15 | Подключение по SSH, активация окружения, копирование конфигурации |
| 0:15-0:20 | Шаг 10-11: индексирование референса, проверка BAM, объяснение BAM-формата |
| 0:20-0:30 | Шаг 20: запуск freebayes; пока ждём: объяснение формата VCF |
| 0:30-0:40 | Изучение raw.vcf: CHROM, POS, REF, ALT, QUAL, INFO |
| 0:40-0:45 | Шаг 30: bgzip + tabix. Объяснение: почему bgzip, а не gzip? |
| 0:45-0:55 | Шаг 40: фильтрация. Обсуждение: что означают QUAL, DP, AF? |
| 0:55-1:05 | Шаг 50: статистика. Ti/Tv — что это и зачем? SNP vs indel |
| 1:05-1:15 | Шаг 60: разбор 3 примеров. Дискуссия: доверяем или нет? |
| 1:15-1:30 | Работа с bcftools query: извлечение данных из VCF |
| 1:30-1:45 | Знакомство с полями INFO от freebayes: AO, RO, SRP, SAP |
| 1:45-1:55 | Назначение ДЗ: variant defense. Запуск 90_homework_assign_variants.py |
| 1:55-2:00 | Итоги: variant calling в реальных проектах, ограничения, WGS vs WES |

## 9. Примечания о лицензиях

- **Геном B. subtilis 168**: NCBI RefSeq, общественное достояние.
- **Симулированные прочтения**: генерируются wgsim (seed=42), воспроизводимы.
- **Материалы курса**: лицензия MIT.

Не коммитьте BAM-файлы и FASTA в git-репозиторий. Они исключены через .gitignore.

## 10. Устранение неполадок

См. `docs/troubleshooting.md` для описания частых проблем и их решений.
