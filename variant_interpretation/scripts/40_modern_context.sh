#!/usr/bin/env bash
set -euo pipefail

# ── 40_modern_context.sh ──────────────────────────────────────────────
# Шаг 40 (необязательный): Обзор современных инструментов интерпретации.
#
# Справочный скрипт: описывает инструменты без их запуска.
# Генерирует outputs/modern_tools_overview.md для студентов.
#
# Usage:
#   bash scripts/40_modern_context.sh
# ────────────────────────────────────────────────────────────────────

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
CONFIG="${REPO_ROOT}/workflow/config.sh"

if [ ! -f "$CONFIG" ]; then
    echo "ERROR: workflow/config.sh не найден."
    echo "       cp workflow/config.sh.example workflow/config.sh"
    exit 1
fi

source "$CONFIG"
OUTDIR="${REPO_ROOT}/${OUTDIR}"
mkdir -p "${OUTDIR}"
OUT="${OUTDIR}/modern_tools_overview.md"

echo "==> Шаг 40: Контекст современных инструментов"
echo ""

cat > "$OUT" <<'MD'
# Современные инструменты интерпретации вариантов

Практикум охватывает классический подход (VEP + bcftools).
Ниже — ориентиры для дальнейшего изучения.

---

## Аннотация вариантов

| Инструмент | Описание | Ссылка |
|------------|----------|--------|
| **Ensembl VEP** | Стандарт аннотации; поддерживает HGVS, gnomAD, ClinVar | ensembl.org/vep |
| **ANNOVAR** | Быстрая мультибазная аннотация; популярен в клинике | annovar.openbioinformatics.org |
| **SnpEff** | Предсказание эффектов на основе аннотации генома | pcingola.github.io/SnpEff |
| **VCFanno** | Аннотация VCF из произвольных BED/VCF/TABIX файлов | github.com/brentp/vcfanno |

## Приоритизация и патогенность

| Инструмент | Описание |
|------------|----------|
| **CADD** | Комбинированный скор патогенности (>3B вариантов precomputed) |
| **AlphaMissense** | Deep learning предсказание патогенности миссенс-вариантов (DeepMind, 2023) |
| **SpliceAI** | Предсказание влияния на сплайсинг (Illumina) |
| **PrimateAI-3D** | Эволюционная модель + структура белка |
| **REVEL** | Ансамблевая модель для миссенс-вариантов |

## Базы данных

| База | Содержимое |
|------|-----------|
| **ClinVar** | Клинически значимые варианты с курируемыми оценками |
| **gnomAD v4** | ~730,000 экзомов + ~76,000 геномов; популяционные частоты |
| **OMIM** | Наследственные заболевания и их генетическая основа |
| **LOVD** | Варианты в конкретных генах (по заболеванию) |
| **Franklin (Genoox)** | AI-ассистент интерпретации по ACMG критериям |

## Структурные варианты

| Инструмент | Тип | Описание |
|------------|-----|----------|
| **Manta** | SV caller | Соматические и герминальные SV |
| **LUMPY/smoove** | SV caller | Комбинирует читы с парными концами + глубину |
| **CNVkit** | CNV | Из NGS данных без reference panel |
| **GATK gCNV** | CNV | Байесовский CNV caller из WGS/WES |
| **AnnotSV** | Аннотация SV | Аналог VEP для SV |

## ACMG/AMP критерии (2015 + обновления)

Стандарт классификации вариантов в клинической генетике:

```
Патогенный       — PVS1 + ≥1 критерий или ≥2 сильных
Вероятно патог.  — ≥1 сильный + ≥2 умеренных
Неопределённый   — не соответствует критериям VUS
Вероятно доброк. — ≥2 доброкачественных
Доброкачественный— ≥1 самостоятельного критерия
```

Критерии:
- **PVS1** — Потеря функции (frameshift, splice, stop) в гене с LOF механизмом
- **PS1/PM5** — Тот же/похожий аминокислотный вариант известен как патогенный
- **PM2** — Отсутствует в gnomAD (или AF < 0.001%)
- **PP3** — Множество предсказателей патогенности согласны
- **BA1** — AF > 5% в gnomAD → доброкачественный
- **BS3** — Функциональные эксперименты показывают нормальную функцию

## AI-инструменты нового поколения (2023-2024)

- **AlphaFold 3** — Структура белок-нуклеиновая кислота-лиганд
- **ESM2/ESMFold** — Языковые модели для белков (Meta AI)
- **Nucleotide Transformer** — Foundation model для геномных последовательностей
- **GPN-MSA** — Предсказание патогенности из множественного выравнивания приматов

---
*Создано: $(date)*
MD

# Заменяем $(date) на текущую дату
sed -i.bak "s/\$(date)/$(date)/" "$OUT" && rm -f "${OUT}.bak"

# Выводим краткую версию на экран
echo "━━━ Ключевые категории инструментов ━━━"
echo ""
echo "  1. Аннотация:      VEP, ANNOVAR, SnpEff, VCFanno"
echo "  2. Патогенность:   CADD, AlphaMissense, SpliceAI, REVEL"
echo "  3. Базы данных:    ClinVar, gnomAD v4, OMIM, Franklin"
echo "  4. SV/CNV:         Manta, LUMPY, CNVkit, AnnotSV"
echo "  5. ACMG/AMP:       Стандарт классификации вариантов"
echo "  6. AI:             AlphaFold 3, ESM2, Nucleotide Transformer"
echo ""
echo "==> Обзор сохранён: ${OUT}"
echo ""
echo "    Документация: docs/advanced_reading.md"
